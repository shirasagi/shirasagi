(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};this.Openlayers_Map_Form=function(){function e(e,o){null==o&&(o={}),this.clonePointForm=t(this.clonePointForm,this),this.canvas=e,this.opts=o,this.markerFeature=null,this.markerLayer=null,this.popup=null,this.maxPointForm=10,this.deleteMessage="\u30de\u30fc\u30ab\u30fc\u3092\u524a\u9664\u3057\u3066\u3088\u308d\u3057\u3044\u3067\u3059\u304b\uff1f",this.dataID=0,this.markerIcon="/assets/img/map-marker.png",this.clickIcon="/assets/img/map-marker-click.png",this.clickMarkerId=null,this.render()}return e.prototype.getMapLoc=function(t){var e;return e=t.val().split(","),[parseFloat(e[0]),parseFloat(e[1])]},e.prototype.setMapLoc=function(t,e,o){e=Math.ceil(e*Math.pow(10,6))/Math.pow(10,6),o=Math.ceil(o*Math.pow(10,6))/Math.pow(10,6),t.val(e.toFixed(6)+","+o.toFixed(6))},e.prototype.render=function(){return this.initMap(),this.renderMarkers(),this.initPopup(),this.resize(),this.renderEvents()},e.prototype.createLayers=function(t){var e,o,i,r,n,s,a,l;for(i=[],e=0,r=t.length;r>e;e++)n=t[e],a=n.source,l=n.url,s=n.projection,o=new ol.layer.Tile({source:new ol.source[a]({url:l,projection:s})}),i.push(o);return i},e.prototype.initMap=function(){var t,e;return t=this.opts.center||[138.252924,36.204824],e=this.opts.layers,e||(e=[{source:"XYZ",url:"http://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",projection:"EPSG:3857"}]),this.maxPointForm=this.opts.max_point_form||10,this.map=new ol.Map({target:this.canvas,renderer:["canvas","dom"],layers:this.createLayers(e),controls:ol.control.defaults({attributionOptions:{collapsible:!1}}),view:new ol.View({projection:"EPSG:3857",center:ol.proj.transform(t,"EPSG:4326","EPSG:3857"),maxZoom:18,zoom:this.opts.zoom||10}),logo:!1})},e.prototype.initPopup=function(){return $("body").append('<div id="marker-popup"><div class="closer"></div><div class="content"></div></div>'),this.popup=$("#marker-popup"),this.popup.hide(),this.popupOverlay=new ol.Overlay({element:this.popup.get(0),autoPan:!0,autoPanAnimation:{duration:250}}),this.map.addOverlay(this.popupOverlay),this.map.on("pointermove",function(t){return function(e){var o,i,r;return e.dragging?void t.popup.hide():(r=t.map.getEventPixel(e.originalEvent),i=t.map.hasFeatureAtPixel(r),o=i?"pointer":"",t.map.getTarget().style.cursor=o)}}(this)),this.popup.find(".closer").on("click",function(t){return function(e){return t.popupOverlay.setPosition(void 0),$(t).blur(),!1}}(this))},e.prototype.renderMarkers=function(){return $(".mod-map dd.marker").each(function(t){return function(e,o){var i;return $(o).attr("data-id",t.dataID),""!==$(o).find(".marker-loc").val()&&(i=t.getMapLoc($(o).find(".marker-loc")),t.setMarker(i,{id:parseInt(t.dataID)})),t.dataID+=1}}(this))},e.prototype.showPopup=function(t,e){var o,i;return i=e.get("markerId"),0===i||i?(o="",$('dd[data-id = "'+i+'"]').each(function(){var t,e;return t=$(this).find(".marker-name").val(),e=$(this).find(".marker-text").val(),t&&(o+="<p>"+t+"</p>"),e?$.each(e.split(/[\r\n]+/),function(){return o+=this.match(/^https?:\/\//)?'<p><a href="'+this+'">'+this+"</a></p>":"<p>"+this+"</p>"}):void 0}),o?(this.popup.find(".content").html(o),this.popup.attr({dataId:i}),this.popup.show(),this.popupOverlay.setPosition(t.coordinate)):void 0):void this.popup.hide()},e.prototype.setMarker=function(t,e){var o,i,r,n,s,a,l;return null==e&&(e={}),a=this.markerIcon,e.image&&(a=e.image),l=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",src:a})}),i=[t[1],t[0]],o=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(i,"EPSG:4326","EPSG:3857")),markerId:null!=(r=e.id)?r:null,markerHtml:null!=(n=e.html)?n:null,category:null!=(s=e.category)?s:null}),o.setStyle(l),this.markerLayer?this.markerLayer.getSource().addFeature(o):(this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[o]})}),this.map.addLayer(this.markerLayer)),o},e.prototype.getMarker=function(t){var e,o;return e=null,this.markerLayer?(o=this.markerLayer.getSource(),o.forEachFeature(function(o){return o.get("markerId")===t?e=o:void 0}),e):e},e.prototype.removeMarker=function(t){var e,o;return e=this.getMarker(t),e?(o=this.markerLayer.getSource(),o.removeFeature(e),e.get("markerId")===parseInt(this.popup.attr("dataId"))&&this.popup.hide(),!0):!1},e.prototype.renderEvents=function(){return this.map.on("click",function(t){return function(e){var o,i,r;if(o=t.map.forEachFeatureAtPixel(e.pixel,function(t,e){return t}))return void t.showPopup(e,o);for(t.clickMarkerId&&(o=t.getMarker(t.clickMarkerId),r=t.markerLayer.getSource(),r.removeFeature(o)),i=ol.proj.transform(e.coordinate,"EPSG:3857","EPSG:4326");i[0]<180;)i[0]+=360;for(;i[0]>180;)i[0]-=360;return i.reverse(),t.clickMarkerId="click",t.setMarker(i,{image:t.clickIcon,id:t.clickMarkerId}),t.setMapLoc($(".mod-map .clicked"),i[0],i[1])}}(this)),$(".mod-map .add-marker").on("click",function(t){return function(e){return t.clonePointForm(),!1}}(this)),$(".mod-map .clear-marker").on("click",function(t){return function(e){var o;return o=e.target,t.clearPointForm($(o).closest("dd.marker")),!1}}(this)),$(".mod-map .set-marker").on("click",function(t){return function(e){var o;return o=e.target,t.createMarker($(o).closest("dd.marker")),!1}}(this)),$(".mod-map .marker-name").on("keypress",function(t){return 13===t.which?!1:void 0}),$(".mod-map .marker-loc-input").on("keypress",function(t){return 13===t.which?($(this).closest("dd.marker").find(".set-marker").trigger("click"),!1):void 0}),$(".mod-map .marker-loc-input").on("focus",function(t){return function(e){var o,i;return t.clickMarkerId?(o=t.getMarker(t.clickMarkerId),i=t.markerLayer.getSource(),i.removeFeature(o),t.clickMarkerId=null,$(".mod-map .clicked").val("")):void 0}}(this)),$(".location-search").hide()},e.prototype.clonePointForm=function(){var t;$(".mod-map dd.marker").length<this.maxPointForm&&(t=$(".mod-map dd.marker:last").clone(!1).insertAfter($(".mod-map dd.marker:last")),t.attr("data-id",this.dataID),this.dataID+=1,t.find("input,textarea").val(""),t.find(".marker-name").val(""),t.find(".clear-marker").on("click",function(e){return function(){return e.clearPointForm(t)}}(this)),t.find(".set-marker").on("click",function(e){return function(){return e.createMarker(t)}}(this)),t.find(".marker-name").on("keypress",function(t){return function(t){return 13===t.which?!1:void 0}}(this)),t.find(".marker-loc-input").on("keypress",function(t){return 13===t.which?($(t.target).closest("dd.marker").find(".set-marker").trigger("click"),!1):void 0}),t.find(".marker-loc-input").on("focus",function(t){return function(e){var o,i;return t.clickMarkerId?(o=t.getMarker(t.clickMarkerId),i=t.markerLayer.getSource(),i.removeFeature(o),t.clickMarkerId=null,$(".mod-map .clicked").val("")):void 0}}(this))),$(".mod-map dd.marker").length===this.maxPointForm&&$(".mod-map dd .add-marker").parent().hide()},e.prototype.createMarker=function(t){var e,o;return o=null,""!==$(".mod-map .clicked").val()?o=$(".mod-map .clicked").val():""!==t.find(".marker-loc-input").val()&&(Map_Form.validateLoc(t.find(".marker-loc-input"))?o=t.find(".marker-loc-input").val():alert("\u6b63\u3057\u3044\u5ea7\u6a19\u3092\u30ab\u30f3\u30de(,)\u533a\u5207\u308a\u3067\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002 \u4f8b\uff0933.8957612,133.6806607")),o?(t.find(".marker-loc").val(o),t.find(".marker-loc-input").val(o),e=parseInt(t.attr("data-id")),this.removeMarker(e),this.setMarker(this.getMapLoc(t.find(".marker-loc")),{id:e})):void 0},e.prototype.clearPointForm=function(t){var e;""!==t.find(".marker-loc").val()?confirm(this.deleteMessage)&&(e=parseInt(t.attr("data-id")),this.removeMarker(e),t.find("input,textarea").val(""),$(".mod-map dd.marker").length>1&&t.remove()):(e=parseInt(t.attr("data-id")),this.removeMarker(e),t.find("input,textarea").val(""),$(".mod-map dd.marker").length>1&&t.remove()),$(".mod-map dd .add-marker").parent().show()},e.prototype.resize=function(){var t;if(this.markerLayer)return t=this.markerLayer.getSource().getExtent(),this.map.getView().fit(t,this.map.getSize())},e}()}).call(this);