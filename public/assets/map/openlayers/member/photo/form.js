(function(){this.Openlayers_Member_Photo_Form=function(){function t(t,e){null==e&&(e={}),this.canvas=t,this.opts=e,this.markerFeature=null,this.markerLayer=null,this.popup=null,this.maxPointForm=10,this.deleteMessage="\u30de\u30fc\u30ab\u30fc\u3092\u524a\u9664\u3057\u3066\u3088\u308d\u3057\u3044\u3067\u3059\u304b\uff1f",this.setExifMessage="\u753b\u50cf\u306b\u4f4d\u7f6e\u60c5\u5831\u304c\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u3002\u4f4d\u7f6e\u60c5\u5831\u3092\u5730\u56f3\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u304b\uff1f",this.dataID=0,this.markerIcon="/assets/img/map-marker.png",this.clickIcon="/assets/img/map-marker-click.png",this.clickMarkerId=null,this.render()}return t.prototype.getMapLoc=function(t){var e;return e=t.val().split(","),[parseFloat(e[0]),parseFloat(e[1])]},t.prototype.setMapLoc=function(t,e,i){e=Math.ceil(e*Math.pow(10,6))/Math.pow(10,6),i=Math.ceil(i*Math.pow(10,6))/Math.pow(10,6),t.val(e.toFixed(6)+","+i.toFixed(6))},t.prototype.render=function(){return this.initMap(),this.renderMarkers(),this.resize(),this.renderEvents()},t.prototype.createLayers=function(t){var e,i,o,r,n,s,a,l;for(o=[],e=0,r=t.length;r>e;e++)n=t[e],a=n.source,l=n.url,s=n.projection,i=new ol.layer.Tile({source:new ol.source[a]({url:l,projection:s})}),o.push(i);return o},t.prototype.initMap=function(){var t,e;return t=this.opts.center||[138.252924,36.204824],e=this.opts.layers,e||(e=[{source:"XYZ",url:"http://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",projection:"EPSG:3857"}]),this.map=new ol.Map({target:this.canvas,renderer:["canvas","dom"],layers:this.createLayers(e),controls:ol.control.defaults({attributionOptions:{collapsible:!1}}),view:new ol.View({projection:"EPSG:3857",center:ol.proj.transform(t,"EPSG:4326","EPSG:3857"),maxZoom:18,zoom:this.opts.zoom||10}),logo:!1})},t.prototype.setCenter=function(t){var e;return e=[t[1],t[0]],this.map.getView().setCenter(ol.proj.transform(e,"EPSG:4326","EPSG:3857"))},t.prototype.renderMarkers=function(){return $(".mod-map .marker").each(function(t){return function(e,i){var o;return $(i).attr("data-id",t.dataID),""!==$(i).find(".marker-loc").val()&&(o=t.getMapLoc($(i).find(".marker-loc")),t.setMarker(o,{id:parseInt(t.dataID)})),t.dataID+=1}}(this))},t.prototype.setMarker=function(t,e){var i,o,r,n,s,a,l;return null==e&&(e={}),a=this.markerIcon,e.image&&(a=e.image),l=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",src:a})}),o=[t[1],t[0]],i=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(o,"EPSG:4326","EPSG:3857")),markerId:null!=(r=e.id)?r:null,markerHtml:null!=(n=e.html)?n:null,category:null!=(s=e.category)?s:null}),i.setStyle(l),this.markerLayer?(console.log(this.markerLayer.getSource()),this.markerLayer.getSource().addFeature(i)):(this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[i]})}),this.map.addLayer(this.markerLayer)),i},t.prototype.getMarker=function(t){var e,i;return e=null,this.markerLayer?(i=this.markerLayer.getSource(),i.forEachFeature(function(i){return i.get("markerId")===t?e=i:void 0}),e):e},t.prototype.removeMarker=function(t){var e,i;return e=this.getMarker(t),e?(i=this.markerLayer.getSource(),i.removeFeature(e),!0):!1},t.prototype.renderEvents=function(){return this.map.on("click",function(t){return function(e){var i,o;for(i=t.map.forEachFeatureAtPixel(e.pixel,function(t,e){return t}),o=ol.proj.transform(e.coordinate,"EPSG:3857","EPSG:4326");o[0]<180;)o[0]+=360;for(;o[0]>180;)o[0]-=360;return o.reverse(),t.setMapLoc($(".mod-map .clicked"),o[0],o[1]),t.setMapLoc($(".mod-map .marker-loc"),o[0],o[1]),console.log(),t.createMarker($(".mod-map .marker-loc"))}}(this)),$(".mod-map .clear-marker").on("click",function(t){return function(e){return t.clearMarker($(".mod-map .marker-loc")),!1}}(this))},t.prototype.createMarker=function(t){var e;return e=0,this.removeMarker(e),this.setMarker(this.getMapLoc(t),{id:e})},t.prototype.clearMarker=function(t){var e;e=0,""!==t.val()?confirm(this.deleteMessage)&&(this.removeMarker(e),t.val("")):this.removeMarker(e)},t.prototype.setExifLatLng=function(t){return $(t).change(function(t){return function(e){var i;if(e.target.files[0])return i=t,EXIF.getData(e.target.files[0],function(){var t,e,o,r;return t=EXIF.getTag(this,"GPSLatitude"),o=EXIF.getTag(this,"GPSLongitude"),e=EXIF.getTag(this,"GPSLatitudeRef")||"N",r=EXIF.getTag(this,"GPSLongitudeRef")||"W",t&&o&&confirm(i.setExifMessage)?(e="N"===e?1:-1,r="W"===r?-1:1,t=(t[0]+t[1]/60+t[2]/3600)*e,o=(o[0]+o[1]/60+o[2]/3600)*r,$(".mod-map .clicked").val([t,o].join()),$(".mod-map .marker-loc").val([t,o].join()),i.createMarker($(".mod-map .marker-loc")),i.setCenter([t,o])):!1})}}(this))},t.prototype.resize=function(){var t;if(this.markerLayer)return t=this.markerLayer.getSource().getExtent(),this.map.getView().fit(t,this.map.getSize())},t}()}).call(this);