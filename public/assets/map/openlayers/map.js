this.Openlayers_Map=function(){function r(e,t){null==t&&(t={}),this.canvas=e,(this.opts=t).zoom&&this.validateZoom(t.zoom)&&(this.zoom=t.zoom),this.defaultZoom=r.defaultZoom,t.center&&this.validateLatLon(t.center[1],t.center[0])&&(this.center=t.center),this.defaultCenter=r.defaultCenter.reverse(),this.showGoogleMapsSearch=!1,t.showGoogleMapsSearch&&(this.showGoogleMapsSearch=t.showGoogleMapsSearch),this.markerFeature=null,this.markerLayer=null,this.popup=null,this.markerIcon=r.markerIcon,this.loadedLayers=[],this.render()}return r.defaultCenter=[36.204824,138.252924],r.defaultZoom=10,r.markerIcon="/assets/img/googlemaps/marker1.png",r.clickIcon="/assets/img/googlemaps/marker17.png",r.prototype.getCenter=function(){return this.center?this.center:this.defaultCenter},r.prototype.getZoom=function(){return this.zoom?this.zoom:this.defaultZoom},r.prototype.render=function(){this.initMap(),this.initPopup(),this.opts.markers&&this.renderMarkers(this.opts.markers),this.resize(),this.renderEvents()},r.prototype.createLayers=function(e){var t,r,o,a,i,s,n,p;for(o=[],t=0,a=e.length;t<a;t++)n=(i=e[t]).source,p=i.url,s=i.projection,r=new ol.layer.Tile({source:new ol.source[n]({url:p,projection:s})}),o.push(r);return o},r.prototype.initMap=function(){var e;(e=this.opts.layers)||(e=[{source:"XYZ",url:"https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",projection:"EPSG:3857"}]),this.map=new ol.Map({target:this.canvas,renderer:["canvas","dom"],layers:this.createLayers(e),controls:ol.control.defaults({attributionOptions:{collapsible:!1}}),view:new ol.View({projection:"EPSG:3857",center:ol.proj.transform(this.getCenter(),"EPSG:4326","EPSG:3857"),maxZoom:18,zoom:this.getZoom()}),logo:!0})},r.prototype.initPopup=function(){var o,e;$("body").append('<div id="marker-popup"><div class="closer"></div><div class="content"></div></div>'),this.popup=$("#marker-popup"),this.popup.hide(),this.popupOverlay=new ol.Overlay({element:this.popup.get(0),autoPan:!0,autoPanAnimation:{duration:250}}),this.map.addOverlay(this.popupOverlay),this.map.on("pointermove",(o=this,function(e){var t,r;if(!e.dragging)return r=o.map.getEventPixel(e.originalEvent),t=o.map.hasFeatureAtPixel(r)?"pointer":"",o.map.getTarget().style.cursor=t;o.popup.hide()})),this.popup.find(".closer").on("click",(e=this,function(){return e.popupOverlay.setPosition(void 0),$(e).blur(),!1}))},r.prototype.showPopup=function(e,t){var r;(r=e.get("markerHtml"))?(this.popup.find(".content").html(r),this.popup.show(),this.popupOverlay.setPosition(t)):this.popup.hide()},r.prototype.renderEvents=function(){var r;this.map.on("click",(r=this,function(e){var t;(t=r.map.forEachFeatureAtPixel(e.pixel,function(e){return e}))&&r.showPopup(t,e.coordinate)}))},r.prototype.createMarkerStyle=function(e){return new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",src:e})})},r.prototype.setMarker=function(e,t){var r,o,a,i;return null==t&&(t={}),o=this.markerIcon,t.image&&(o=t.image),i=this.createMarkerStyle(o),a=[e[1],e[0]],(r=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(a,"EPSG:4326","EPSG:3857")),markerId:t.id,markerHtml:t.html,category:t.category})).setStyle(i),this.markerLayer?this.markerLayer.getSource().addFeature(r):(this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[r]})}),this.map.addLayer(this.markerLayer)),r},r.prototype.getMarker=function(t){var r;return r=null,this.markerLayer&&this.markerLayer.getSource().forEachFeature(function(e){if(e.get("markerId")===t)return r=e}),r},r.prototype.getMarkers=function(){return this.markerLayer.getSource().getFeatures()},r.prototype.removeMarkers=function(){var t;this.popup&&this.popup.hide(),this.markerLayer&&(t=this.markerLayer.getSource()).forEachFeature(function(e){t.removeFeature(e)})},r.prototype.setCenter=function(e){return this.map.getView().setCenter(ol.proj.transform(e,"EPSG:4326","EPSG:3857"))},r.prototype.setZoom=function(e){return this.map.getView().setZoom(e)},r.prototype.renderMarkers=function(e){var t,r,o,a,i,s,n,p,h;for(o=0;o<e.length;o++)a=e[o],r=this.markerIcon,a.image&&(r=a.image),p=this.createMarkerStyle(r),s=a.name,h=a.text,n=[a.loc[0],a.loc[1]],i="",s&&(i+="<p>"+s+"</p>"),h&&$.each(h.split(/[\r\n]+/),function(){this.match(/^https?:\/\//)?i+='<p><a href="'+this+'">'+this+"</a></p>":i+="<p>"+this+"</p>"}),this.showGoogleMapsSearch&&(i+=Googlemaps_Map.getMapsSearchHtml(n[1],n[0])),(t=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(n,"EPSG:4326","EPSG:3857")),markerId:a.id,markerHtml:i,category:a.category})).setStyle(p),this.markerLayer||(this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector}),this.map.addLayer(this.markerLayer)),this.markerLayer.getSource().addFeature(t)},r.prototype.resize=function(){if(this.markerLayer){var e=this.markerLayer.getSource().getFeatures().length;if(0<=e){var t=this.markerLayer.getSource().getExtent();this.map.getView().fit(t,this.map.getSize()),1==e&&this.map.getView().setZoom(this.getZoom()),this.center&&this.setCenter(this.getCenter()),this.zoom&&this.setZoom(this.getZoom())}else this.setCenter(this.getCenter()),this.setZoom(this.getZoom())}},r.prototype.loadLayer=function(i,e){var s=this,n=i,p=e,h=new ol.source.Vector({format:new p,loader:function(t,e,r){r.getCode();var o=new XMLHttpRequest,a=function(){console.log("loadLayer error:"+i)};o.open("GET",n),o.onerror=a,o.onloadstart=function(){$(s.canvas).hide()},o.onload=function(){if(200==o.status){var e=(new p).readFeatures(o.responseText,{featureProjection:r});h.addFeatures(e),t=u.getSource().getExtent(),$(s.canvas).show(),s.map.getView().fit(t,s.map.getSize()),s.map.getView().getZoom()>s.opts.zoom&&s.map.getView().setZoom(s.opts.zoom)}else a()},o.send()}}),u=new ol.layer.Vector({source:h});this.map.addLayer(u),this.loadedLayers.push(u)},r.prototype.validateZoom=function(e){return 3<=e&&e<=18},r.prototype.validateLatLon=function(e,t){return-90<=e&&e<=90&&-180<=t&&t<=180},r.prototype.removeloadedLayers=function(){var e=this;$.each(this.loadedLayers,function(){e.map.removeLayer(this)})},r}();