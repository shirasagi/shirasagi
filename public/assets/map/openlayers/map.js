(function(){this.Openlayers_Map=function(){function t(t,e){null==e&&(e={}),this.canvas=t,this.opts=e,this.markerFeature=null,this.markerLayer=null,this.popup=null,this.markerIcon="/assets/img/map-marker.png",this.render()}return t.prototype.render=function(){return this.initMap(),this.initPopup(),this.opts.markers&&this.renderMarkers(this.opts.markers),this.resize(),this.renderEvents()},t.prototype.createLayers=function(t){var e,o,i,r,n,s,a,l;for(i=[],e=0,r=t.length;r>e;e++)n=t[e],a=n.source,l=n.url,s=n.projection,o=new ol.layer.Tile({source:new ol.source[a]({url:l,projection:s})}),i.push(o);return i},t.prototype.initMap=function(){var t,e;return t=this.opts.center||[138.252924,36.204824],e=this.opts.layers,e||(e=[{source:"XYZ",url:"http://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",projection:"EPSG:3857"}]),this.map=new ol.Map({target:this.canvas,renderer:["canvas","dom"],layers:this.createLayers(e),controls:ol.control.defaults({attributionOptions:{collapsible:!1}}),view:new ol.View({projection:"EPSG:3857",center:ol.proj.transform(t,"EPSG:4326","EPSG:3857"),maxZoom:18,zoom:this.opts.zoom||10}),logo:!0})},t.prototype.initPopup=function(){return $("body").append('<div id="marker-popup"><div class="closer"></div><div class="content"></div></div>'),this.popup=$("#marker-popup"),this.popup.hide(),this.popupOverlay=new ol.Overlay({element:this.popup.get(0),autoPan:!0,autoPanAnimation:{duration:250}}),this.map.addOverlay(this.popupOverlay),this.map.on("pointermove",function(t){return function(e){var o,i,r;return e.dragging?void t.popup.hide():(r=t.map.getEventPixel(e.originalEvent),i=t.map.hasFeatureAtPixel(r),o=i?"pointer":"",t.map.getTarget().style.cursor=o)}}(this)),this.popup.find(".closer").on("click",function(t){return function(e){return t.popupOverlay.setPosition(void 0),$(t).blur(),!1}}(this))},t.prototype.showPopup=function(t,e){var o;return(o=t.get("markerHtml"))?(this.popup.find(".content").html(o),this.popup.show(),this.popupOverlay.setPosition(e)):void this.popup.hide()},t.prototype.renderEvents=function(){return this.map.on("click",function(t){return function(e){var o;o=t.map.forEachFeatureAtPixel(e.pixel,function(t,e){return t}),o&&t.showPopup(o,e.coordinate)}}(this))},t.prototype.createMarkerStyle=function(t){return new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",src:t})})},t.prototype.setMarker=function(t,e){var o,i,r,n,s,a,l;return null==e&&(e={}),i=this.markerIcon,e.image&&(i=e.image),l=this.createMarkerStyle(i),r=[e.loc[1],e.loc[0]],o=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(r,"EPSG:4326","EPSG:3857")),markerId:null!=(n=e.id)?n:null,markerHtml:null!=(s=e.html)?s:null,category:null!=(a=e.category)?a:null,iconSrc:i}),o.setStyle(l),this.markerLayer?this.markerLayer.getSource().addFeature(o):(this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[o]})}),this.map.addLayer(this.markerLayer)),o},t.prototype.getMarker=function(t){var e,o;return e=null,this.markerLayer?(o=this.markerLayer.getSource(),o.forEachFeature(function(o){return o.get("markerId")===t?e=o:void 0}),e):e},t.prototype.getMarkers=function(){var t,e;return e=this.markerLayer.getSource(),t=e.getFeatures()},t.prototype.setCenter=function(t){return this.map.getView().setCenter(ol.proj.transform(t,"EPSG:4326","EPSG:3857"))},t.prototype.setZoom=function(t){return this.map.getView().setZoom(t)},t.prototype.renderMarkers=function(t){var e,o,i,r,n,s,a,l,u,p,h,c,d;h=[];for(i in t)r=t[i],o="/assets/img/map-marker.png",r.image&&(o=r.image),c=this.createMarkerStyle(o),n="",s=r.name,d=r.text,s&&(n+="<p>"+s+"</p>"),d&&$.each(d.split(/[\r\n]+/),function(){return n+=this.match(/^https?:\/\//)?'<p><a href="'+this+'">'+this+"</a></p>":"<p>"+this+"</p>"}),a=[r.loc[1],r.loc[0]],e=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(a,"EPSG:4326","EPSG:3857")),markerId:null!=(l=r.id)?l:i,markerHtml:null!=(u=r.html)?u:n,category:null!=(p=r.category)?p:null,iconSrc:o}),e.setStyle(c),this.markerLayer?h.push(this.markerLayer.getSource().addFeature(e)):(this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[e]})}),h.push(this.map.addLayer(this.markerLayer)));return h},t.prototype.resize=function(){var t;if(this.markerLayer)return t=this.markerLayer.getSource().getExtent(),this.map.getView().fit(t,this.map.getSize())},t}()}).call(this);