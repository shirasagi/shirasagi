#!/usr/bin/env ruby
require "fileutils"

# path to your application root.
APP_ROOT = File.expand_path("..", __dir__)
DEFAULT_PORT = "3000"
PORT = ENV.fetch("PORT", DEFAULT_PORT)

def system!(*args)
  system(*args, exception: true)
end

FileUtils.chdir APP_ROOT do
  # This script is a way to set up or update your development environment automatically.
  # This script is idempotent, so that you can run it at any time and get an expectable outcome.
  # Add necessary setup steps to this file.

  puts "== Installing dependencies =="
  system! "gem install bundler --conservative"
  system("bundle check") || system!("bundle install")
  system! "yarn install"
  system! "yarn build"

  puts "== mecab-ruby =="
  system! "tar xzf vendor/mecab/mecab-ruby-0.996.tar.gz && cd mecab-ruby-0.996 && bundle exec ruby extconf.rb && make && sudo make install && cd .. && rm -rf mecab-ruby-0.996"

  puts "== Setup config/mongoid.yml =="
  system! "cp -np config/samples/mongoid-container.yml config/mongoid.yml"

  puts "== Setup config/secrets.yml =="
  system! "cp -np config/samples/secrets.yml config/secrets.yml"

  unless File.exist?("config/environment.yml")
    File.open("config/environment.yml", "wt") do |f|
      f.puts "RAILS_ENV: development"
    end
  end

  puts "== Remove all existing data =="
  system! "bundle exec rake db:drop"
  system! "rm -rf private public"
  system! "git checkout -- private public"

  puts "== Create database =="
  system! "bundle exec rake db:create_indexes"

  puts "== Install seed: '自治体サンプル' =="
  system! "bundle exec rake ss:create_site data=\"{ name: '自治体サンプル', host: 'www', domains: 'www.example.jp:#{PORT}', mypage_domain: 'localhost:#{PORT}', map_api: 'openlayers' }\""
  system! "bundle exec rake db:seed site=www name=demo"

  puts "== Install seed: '企業サンプル' =="
  system! "bundle exec rake ss:create_site data=\"{ name: '企業サンプル', host: 'company', domains: 'company.example.jp:#{PORT}', mypage_domain: 'localhost:#{PORT}', map_api: 'openlayers' }\""
  system! "bundle exec rake db:seed site=company name=company"

  puts "== Install seed: '子育て支援サンプル' =="
  system! "bundle exec rake ss:create_site data=\"{ name: '子育て支援サンプル', host: 'childcare', domains: 'childcare.example.jp:#{PORT}', mypage_domain: 'localhost:#{PORT}', map_api: 'openlayers' }\""
  system! "bundle exec rake db:seed site=childcare name=childcare"

  puts "== Install seed: 'オープンデータ' =="
  system! "bundle exec rake ss:create_site data=\"{ name: 'オープンデータ', host: 'opendata', domains: 'www.example.jp:#{PORT}', mypage_domain: 'localhost:#{PORT}', map_api: 'openlayers', subdir: 'opendata', parent_id: 1 }\""
  system! "bundle exec rake db:seed site=opendata name=opendata"
  system! "bundle exec rake cms:set_subdir_url site=opendata"

  puts "== Install seed: 'LPサンプル' =="
  system! "bundle exec rake ss:create_site data=\"{ name: 'LPサンプル', host: 'lp_', domains: 'lp.example.jp:#{PORT}', mypage_domain: 'localhost:#{PORT}', map_api: 'openlayers' }\""
  system! "bundle exec rake db:seed site=lp_ name=lp"

  puts "== Install seed: 'グループウェア' =="
  system! "bundle exec rake db:seed name=gws"

  puts "== Install seed: 'Webメール' =="
  system! "bundle exec rake db:seed name=webmail"

  puts "\n== Removing auto generated html files =="
  system! "find public/sites/ -name '*.html' -delete"

  puts "\n== Removing old logs and tempfiles =="
  system! "bundle exec rails log:clear tmp:clear"

  puts "\n== Restarting application server =="
  system! "bundle exec rails restart"
end
