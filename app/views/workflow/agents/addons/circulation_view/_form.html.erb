<%

if params[:controller] =~ /^gws/
  def approvers_path(*args); gws_workflow_search_approvers_path(*args); end
else
  def approvers_path(*args); workflow_search_approvers_path(*args); end
end

%>

<h1 class="workflow-level-header"><%= t("workflow.circulation_step") %></h1>
<dl class="see workflow-approvers">
  <dt><%= @model.t :circulations %><%= @model.tt :circulations %></dt>
  <dd>
    <%= f.hidden_field("circulations[]", value: "", class: "hidden-ids", id: nil) %>
    <%= link_to t("workflow.search_circulations.index"), approvers_path(level: "circulation"), class: "ajax-box circulations" %>
  </dd>
  <dd>
    <table class="index ajax-selected">
      <thead>
        <tr>
          <th class="name"><%= @model.t :name %></th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @item.circulation_users.each do |user| %>
          <% if user.present? %>
            <tr data-id="<%= "circulation,#{user.id}" %>">
              <td>
                <%= hidden_field_tag("#{f.object_name}[circulations][][user_id]", user.id, id: nil) %>
                <%= user.long_name %>
              </td>
              <td><%= link_to t("ss.buttons.delete"), "#", class: "deselect btn" %></td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </dd>
</dl>

<%= jquery do %>
  var circulationSelector = function($item) {
    var $dl = SS_SearchUI.anchorAjaxBox.closest("dl");

    var data = $item.closest("[data-id]");
    var levelAndId = data.data("id").split(',');
    var id = levelAndId[1];
    var name = data.data("name") || data.find(".select-item").text() || $item.text() || data.text();

    var $userId = $('<input type="hidden" name="item[circulations][][user_id]">');
    $userId.val(id);

    var $a = $('<a class="deselect btn" href="#"><%= I18n.t "ss.buttons.delete" %></a>');
    $a.on("click", SS_SearchUI.deselect);

    var $tr = $("<tr />").attr("data-id", levelAndId.join(','));
    $tr.append($('<td />').append($userId).append(name));
    $tr.append($('<td />').append($a));
    SS_SearchUI.anchorAjaxBox.closest("dl").find(".ajax-selected tbody").prepend($tr);
    SS_SearchUI.anchorAjaxBox.closest("dl").find(".ajax-selected").trigger("change");
  };

  $('a.ajax-box.circulations').data('on-select', function($item) {
    circulationSelector($item);
  });
<% end %>
