<% value ||= nil %>
<% controller ||= false %>
<%= render 'cms/agents/columns/main/base', f: f, column: column, value: value, controller: controller do %>
  <%= Cms::Column::Value::Youtube.t("url") %><%= text_field_tag("#{f.object_name}[][in_wrap][url]", value.try(:url) || (value.try(:youtube_id) ? "https://youtu.be/#{value.youtube_id}" : ""), column.form_options(:url).merge(id: nil, style: "width: 70%;")) %><br />
  <div class="column-youtube-title" style="display: flex; align-items: center;">
    <dt><%= Cms::Column::Value::Youtube.t("title") %><%= Cms::Column::Value::Youtube.tt("title") %></dt>
    <%= text_field_tag("#{f.object_name}[][in_wrap][title]", value.try(:title), column.form_options(:title).merge(id: "youtube-title-field", style: "width: 70%;")) %>
    <%= button_tag I18n.t("cms.buttons.youtube_title"), type: "button", class: "btn youtube-title-check" %>
  </div>
  <div class="column-youtube-left">
    <%= check_box_tag("#{f.object_name}[][in_wrap][auto_width]", "enabled", value.try(:auto_width) == "enabled", column.form_options(:auto_width).merge(id: "auto-width")) %><label for="auto-width"><%= Cms::Column::Value::Youtube.t("auto_width") %></label>
  </div>
  <div class="column-youtube-right">
    <%= Cms::Column::Value::Youtube.t("width") %><%= text_field_tag("#{f.object_name}[][in_wrap][width]", (value.try(:width) || 640), column.form_options.merge(id: nil, style: "width: 10%;")) %>
    <%= Cms::Column::Value::Youtube.t("height") %><%= text_field_tag("#{f.object_name}[][in_wrap][height]", (value.try(:height) || 360), column.form_options.merge(id: nil, style: "width: 10%;")) %>
  </div>
<% end %>

<%= jquery do %>
  $(function() {
    Cms_Column_Youtube.render($("body"));
  });
<% end %>

<%
=begin%>
 <%= jquery do %>
  $(document).on("click", ".youtube-title-check", function() {
    console.log("youtube-title-check_column_form");
    // ボタンが属するブロック内でURLとタイトルフィールドを取得
    var $block = $(this).closest('.column-youtube-title');
    console.log($block);
    // URLフィールドを同じ親要素内から探す
    var $urlField = $block.parent().find('input[name*="[in_wrap][url]"]');
    var url = $urlField.val();
    if (!url) {
      alert("<%= j(I18n.t('cms.errors.input_youtube_url')) %>");
      return;
    }
    var $titleField = $block.find('input[name*="[in_wrap][title]"]');
    $.get("<%= cms_apis_youtube_title_path %>", { url: url })
      .done(function(data) {
        if (data.title) {
          $titleField.val(data.title);
        } else {
          alert("<%= j(I18n.t('cms.errors.youtube_title_fetch_failed')) %>" + (data.error ? ': ' + data.error : ''));
        }
      })
      .fail(function(xhr) {
        alert("<%= j(I18n.t('cms.errors.network_error')) %>");
      });
  });
<% end %> 
<%
=end%>
