<%
  return "" if @item.files.blank?

  addon ||= local_assigns.fetch(:addon, {})
%>

<dl class="see">
  <dd class="wide">
    <div id="selected-files">
      <% @item.files.each do |file| %>
        <div class="file-view" data-file-id="<%= file.id %>">
          <%= link_to file.url, class: :thumb, target: "_blank" do %>
            <% if file.image? %>
              <%= image_tag file.thumb_url, alt: file.name %>
            <% else %>
              <span class="ext icon-<%= file.extname %>"><%= file.extname %></span>
            <% end %>
          <% end %>

          <div class="name">
            <label>
              <%= file.name %>
            </label><br />
          </div>
        </div>
      <% end %>
    </div>
  </dd>
</dl>

<%= jquery do %>
  var $el = $("#<%= addon[:id] %>");
  $el.on("click", ".file-view a.thumb", function(ev) {
    var $this = $(ev.currentTarget);
    if ($this.find("img").length === 0) {
      return true;
    }

    ev.preventDefault();
    var path = $this.attr("href");
    if (path.startsWith("/fs/")) {
      var $fileView = $(this).closest(".file-view");
      var fileId = $fileView.data("file-id");

      path = "<%= view_cms_apis_content_file_path(id: ":id") %>".replace(":id", fileId);
    }

    $.colorbox({
      href: path,
      width: "90%",
      height: "90%",
      fixed: true,
      open: true,
      onComplete: function() { $("#ss-file-view").trigger("ss:cboxCompleted"); }
    });

    return false;
  });
<% end %>
