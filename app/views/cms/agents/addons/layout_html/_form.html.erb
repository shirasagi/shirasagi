<% addon ||= local_assigns.fetch(:addon, {})%>
<% snippet_select_id = "#{addon[:id]}_loop_snippet_selector" %>
<% loop_setting_select_id = "#{addon[:id]}_loop_setting_id" %>

<%= code_editor "##{addon[:id]} textarea", mode: :html %>

<dl class="see">
  <dt class="wide"><%= t("cms.labels.loop_html") %><%= tt("cms.labels.loop_html") %></dt>
  <dd class="wide">
    <% loop_setting_options = ancestral_loop_settings("liquid") %>
    <%= f.select :loop_setting_id,
          options_with_optgroup_for_loop_settings(loop_setting_options),
          { include_blank: true },
          id: loop_setting_select_id,
          class: 'loop-setting-selector'
        %>
  </dd>
  <dt class="wide"><%= t("cms.labels.snippets") %><%= tt("cms.labels.snippets") %></dt>
  <dd class="wide">
    <% snippet_options = ancestral_html_settings_liquid %>
    <%= select_tag(
          'loop_snippet_selector',
          options_with_optgroup_for_snippets(snippet_options),
          id: snippet_select_id,
          class: 'loop-snippet-selector'
        ) %>
  </dd>
  <dt class="wide"><%= @model.t :html %><%= @model.tt :html %></dt>
  <dd class="wide">
    <%= f.text_area :html, style: "height: 400px" %>

    <% if example = @item.try(:form_example_layout_html) %>
      <div class="form-example">
        <div class="form-example-head example-layout-html"><%= t 'ss.input_example' %></div>
        <div class="form-example-body example-layout-html"><%= example %></div>
      </div>
    <% end %>
  </dd>
  <%=
    component = Cms::BodyCheckerComponent.new(
      cur_site: @cur_site, cur_user: @cur_user, cur_node: @cur_node, item: @item, limits: %i[syntax link],
      syntax_check_context: @syntax_context
    )
    syntax_checker_form = render(component)
    if syntax_checker_form.present?
      tag.dd syntax_checker_form, class: "wide"
    end
  %>
</dl>

<%= jquery do %>
  var $addon = $("<%= "##{addon[:id]}" %>");
  var $loopSettingSelect = $addon.find('#<%= loop_setting_select_id %>');
  var $htmlTextarea = $addon.find('textarea[name*="[html]"]');
  var $snippetSelect = $addon.find('.loop-snippet-selector');
  
  // ループHTML設定の選択時にテキストエリアをロック/アンロックし、HTMLを読み込む
  if ($loopSettingSelect.length && $htmlTextarea.length) {
    // CodeMirrorエディタの初期化を待つ
    var initLock = function() {
      var $codeMirror = $htmlTextarea.next('.CodeMirror');
      if ($codeMirror.length && $codeMirror[0].CodeMirror) {
        Cms_Editor_CodeMirror.lock('#<%= loop_setting_select_id %>', '#<%= addon[:id] %> textarea[name*="[html]"]');
      } else {
        setTimeout(initLock, 100);
      }
    };
    initLock();
    
    var updateLoopHtml = function() {
      var loopSettingId = $loopSettingSelect.val();
      if (loopSettingId) {
        // ループHTML設定が選択されている場合、スニペットのプルダウンを無効にする
        $snippetSelect.prop('disabled', true);
        
        // AJAXでループHTML設定のHTMLを取得
        $.ajax({
          url: '<%= cms_apis_loop_setting_path(id: ":id", site: @cur_site) %>'.replace(':id', loopSettingId),
          method: 'GET',
          dataType: 'json',
          success: function(data) {
            if (data && data.html) {
              var editor = $htmlTextarea.data('editor');
              if (editor) {
                editor.setValue(data.html);
                editor.setOption('readOnly', true);
              } else {
                $htmlTextarea.val(data.html);
                $htmlTextarea.prop('readonly', true);
              }
            }
          },
          error: function(xhr, status, error) {
            console.error('Loop setting fetch error:', xhr, status, error);
          }
        });
      } else {
        // ループHTML設定が選択されていない場合、テキストエリアをアンロックし、スニペットのプルダウンを有効にする
        $snippetSelect.prop('disabled', false);
        
        var editor = $htmlTextarea.data('editor');
        if (editor) {
          editor.setOption('readOnly', false);
        } else {
          $htmlTextarea.prop('readonly', false);
        }
      }
    };
    
    // 初期状態を設定（既にloop_setting_idが設定されている場合）
    if ($loopSettingSelect.val()) {
      updateLoopHtml();
    }
    
    // 選択変更時にHTMLを更新
    $loopSettingSelect.on('change', updateLoopHtml);
  }
  
  // スニペットの選択処理
  $addon.find('.loop-snippet-selector').on('change', function() {
    var $select = $(this);
    
    // ループHTML設定が選択されている場合はスニペットの挿入を無効にする
    if ($loopSettingSelect.length && $loopSettingSelect.val()) {
      $select.val('');
      return;
    }
    
    var $option = $select.find(':selected');
    
    if (!$option.val()) {
      return;
    }
    
    var snippet = $option.data('snippet');
    
    if (!snippet) {
      return;
    }
    
    var $textarea = $select.closest('dl').find('textarea');
    
    if ($textarea.length === 0) {
      return;
    }
    
    var editor = $textarea.data('editor');
    if (editor) {
      var doc = editor.getDoc();
      var cursor = doc.getCursor();
      doc.replaceRange(snippet, cursor);
      editor.focus();
      editor.save();
    } else {
      var textarea = $textarea[0];
      var start = textarea.selectionStart || textarea.value.length;
      var end = textarea.selectionEnd || start;
      
      textarea.value = textarea.value.substring(0, start) + snippet + textarea.value.substring(end);
      
      var cursor = start + snippet.length;
      if (textarea.setSelectionRange) {
        textarea.setSelectionRange(cursor, cursor);
      }
      
      textarea.dispatchEvent(new Event('input', { bubbles: true }));
      textarea.dispatchEvent(new Event('change', { bubbles: true }));
    }
    
    $select.val('');
  });
<% end %>

<% if @syntax_context&.errors.present? && @cur_user.cms_role_permit_any?(@cur_site, "edit_cms_ignore_syntax_check") %>
  <label>
    <%= check_box_tag "ignore_syntax_check", 1, false, id: nil %>
    <%= t("ss.buttons.ignore_alerts_and_save") %>
  </label>
<% end %>
