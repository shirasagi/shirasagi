<%
  addon ||= local_assigns.fetch(:addon, {})
  snippet_select_id = "#{addon[:id]}_loop_snippet_selector"
%>
<%= code_editor "##{addon[:id]} .html", mode: :html %>

<dl class="see">
  <dt class="wide"><%= t("cms.labels.snippets") %><%= tt("cms.labels.snippets") %></dt>
  <dd class="wide">
    <% snippet_options = ancestral_html_settings_liquid %>
    <%= select_tag(
          'loop_snippet_selector',
          tag.option(t("cms.input_directly"), value: "").html_safe +
          snippet_options.map { |name, id, attrs|
            tag.option(name, value: id, data: { snippet: attrs["data-snippet"] })
          }.join.html_safe,
          id: snippet_select_id,
          class: 'loop-snippet-selector'
        ) %>
  </dd>
  <dt class="wide">HTML<%= @model.tt :layout %></dt>
  <dd class="wide">
    <%= f.text_area :layout, style: "height: 400px", class: "html" %>

    <% if example = @model.value_type.form_example_layout %>
      <div class="form-example">
        <div class="form-example-head example-layout-html"><%= t 'ss.input_example' %></div>
        <div class="form-example-body example-layout-html"><%= example %></div>
      </div>
    <% end %>
  </dd>
</dl>

<%= jquery do %>
  var $addon = $("<%= "##{addon[:id]}" %>");
  $addon.find('.loop-snippet-selector').on('change', function() {
    var $select = $(this);
    var $option = $select.find(':selected');
    
    if (!$option.val()) {
      return;
    }
    
    var snippet = $option.data('snippet');
    
    if (!snippet) {
      return;
    }
    
    var $textarea = $select.closest('dl').find('textarea');
    
    if ($textarea.length === 0) {
      return;
    }
    
    var editor = $textarea.data('editor');
    if (editor) {
      var doc = editor.getDoc();
      var cursor = doc.getCursor();
      doc.replaceRange(snippet, cursor);
      editor.focus();
      editor.save();
    } else {
      var textarea = $textarea[0];
      var start = textarea.selectionStart || textarea.value.length;
      var end = textarea.selectionEnd || start;
      
      textarea.value = textarea.value.substring(0, start) + snippet + textarea.value.substring(end);
      
      var cursor = start + snippet.length;
      if (textarea.setSelectionRange) {
        textarea.setSelectionRange(cursor, cursor);
      }
      
      textarea.dispatchEvent(new Event('input', { bubbles: true }));
      textarea.dispatchEvent(new Event('change', { bubbles: true }));
    }
    
    $select.val('');
  });
<% end %>
