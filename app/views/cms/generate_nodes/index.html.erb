<%= jquery do %>

  var reload;
  reload = function () {
    if ($("#task-form .state").html().match(/(ready|running)/)) {
      $.ajax({
        url: "<%= url_for(action: :index, format: :json) %>",
        success: function (data) {
          var closed, started;
          started = data["started"] + "";
          closed = data["closed"] + "";
          $("#task-form .state").html(data["state"]);
          $("#task-form .count").html(data["current_count"] + " / " + data["total_count"]);
          $("#task-form .started").html(started.replace(/\..*/, "").replace("T", " "));
          $("#task-form .closed").html(closed.replace(/\..*/, "").replace("T", " "));
          $("#task-form .log").val(data["head_logs"].join("\n"));
          if (data["state"] === "stop") {
            $("#task-form .stop-button").hide();
            $("#task-form .run-button").show();
          }
        }
      });
    }
  };
  setInterval(reload, 10000);

<% end %>

<div class="main-box">
<%= form_tag({ action: :run }, { id: "task-form" }) do |f| %>

<dl class="info">
  <dt><%= @item.t :state %></dt>
  <dd class="state"><%= @item.send :state %></dd>

  <dt><%= @item.t :current_count %></dt>
  <dd class="count"><%= @item.send :current_count %> / <%= @item.send :total_count %></dd>

  <dt><%= @item.t :started %></dt>
  <dd class="started"><%= tryb { @item.started.strftime("%Y/%m/%d %H:%M:%S") } %></dd>

  <dt><%= @item.t :closed %></dt>
  <dd class="closed"><%= tryb { @item.closed.strftime("%Y/%m/%d %H:%M:%S") } %></dd>
</dl>

<% if @cur_site.generate_locked? %>
  <dl class="see">
    <dd class="wide"><%= @cur_site.t(:generate_locked) %></dd>
  </dl>
<% end %>

<div class="logs">
  <textarea class="log" readonly="readonly"><%= @item.head_logs.join("\n") %></textarea>
</div>

<footer class="send">
  <% hide = (@item.running? || @item.state == "ready") ? nil : "display: none;" %>
  <div class="stop-button" style="<%= hide %>">
    <%= submit_tag t("ss.buttons.stop"), name: "stop", class: "btn-primary stop" %>
    <%= submit_tag t("ss.buttons.reset"), name: "reset", class: "btn-default", onclick: "return confirm('#{t("ss.tasks.confirm_reset")}')" %>
  </div>

  <% hide = hide.present? && !@cur_site.generate_locked? ? "" : "display: none;" %>
  <div class="run-button" style="<%= hide %>">
    <%= submit_tag t("ss.buttons.run"), class: "btn-primary save" %>
  </div>
</footer>

<% end %>
</div>
