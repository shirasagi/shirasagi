<%
  disable_image_resizes = SS::ImageResize.allowed?(:disable, @cur_user) && SS::ImageResize.where(state: SS::ImageResize::STATE_ENABLED).present?
  disable_image_resizes ||= @cur_node.present? && Cms::ImageResize.allowed?(:disable, @cur_user, site: @cur_site, node: @cur_node) && Cms::ImageResize.site(@cur_site).node(@cur_node).where(state: SS::ImageResize::STATE_ENABLED).present?
  min_size = @model.image_resizes_min_attributes(node: @cur_node)['size']
  min_width = @model.image_resizes_min_attributes(node: @cur_node)['max_width']
  min_height = @model.image_resizes_min_attributes(node: @cur_node)['max_height']
%>
<%= jquery do %>
  SS_SearchUI.modal();
<% end %>

<turbo-frame id="ajax-file-box">
  <div class="cms-tabs ajax-file-tabs">
    <%= link_to tag.span("アップロード", class: "tab-name"), cms_frames_temp_files_uploads_path, class: "current", data: { turbo: true } %>
    <%= link_to tag.span("一覧", class: "tab-name"), cms_frames_temp_files_files_path, data: { turbo: true } %>
  </div>

  <div data-controller="ss--temp-file" data-ss--temp-file-preview-api-value="<%= url_for(action: :preview) %>">
    <div class="search-ui-form">
      <%= file_field_tag :in_files, multiple: true, class: "hide", id: nil, data: { "ss--temp-file-target" => "realButton" } %>
      <%= button_tag "ファイル選択", type: :button, name: 'select_file', class: "btn", data: { action: "ss--temp-file#openDialog", "ss--temp-file-target" => "dummyButton" } %>
      <span class="upload-drop-notice">ここにファイルをドロップすることでアップロードできます。</span>
    </div>

    <%= form_with scope: :item, url: url_for(action: :create), data: { turbo: true } do |f| %>
      <%= error_messages_for :item %>

      <table class="index">
        <tbody data-ss--temp-file-target="result">
        </tbody>
      </table>

      <script type="text/plain" data-ss--temp-file-target="template">
        <%% if (selectedItems.length > 0) { %>
          <%% selectedItems.forEach(function(selectedItem) { %>
            <tr data-ss--temp-file-target="resultItem">
              <%% if (selectedItem.errors && selectedItem.errors.length > 0) { %>
                <td><%%= selectedItem.name %></td>
                <td><%%= selectedItem.filename %></td>
                <td><%%= selectedItem.errors.join("\n") %></td>
                <td>
                  <button name="delete" type="button" class="btn" value="delete" data-action="ss--temp-file#deselect">削除</button>
                </td>
              <%% } else { %>
                <td>
                  <input type="text" name="item[files][][name]" value="<%%= selectedItem.name %>">
                </td>
                <td>
                  <input type="text" name="item[files][][filename]" value="<%%= selectedItem.filename %>">
                </td>
                <td>
                  <%% if (selectedItem.is_image) { %>
                    <% if @model.resizing_options(user: @cur_user, node: @cur_node).present? %>
                      <%= f.select :resizing, @model.resizing_options(user: @cur_user, node: @cur_node), { include_blank: t("ss.resize_image_auto") }, { class: "image-size", id: nil } %>
                    <% end %>
                    <% if @model.quality_options(user: @cur_user, node: @cur_node).present? %>
                      <%= f.select :quality, @model.quality_options(user: @cur_user, node: @cur_node), { include_blank: t("ss.quality") }, { id: nil } %>
                    <% end %>
                    <% if disable_image_resizes %>
                      <%= f.select :image_resizes_disabled, @model.image_resizes_disabled_options, {}, { id: nil } %>
                    <% end %>
                    <% if min_size %>
                      <div class="tooltip">?
                        <ul class="tooltip-content">
                          <% t('tooltip.ss/model/file.image_resizes_disabled', size: min_size.to_fs(:human_size), width: min_width, height: min_height).each do |tooltip| %>
                            <li><%= tooltip %><br></li>
                          <% end %>
                        </ul>
                      </div>
                    <% end %>
                  <%% } %>
                </td>
                <td>
                  <button name="delete" type="button" class="btn" value="delete" data-action="ss--temp-file#deselect">アップロード取消</button>
                </td>
              <%% } %>
            </tr>
          <%% }); %>
        <%% } %>
      </script>

      <footer class="send">
        <%= f.submit t("ss.buttons.upload"), class: "save btn", style: "margin-left: 10px;", data: { submitted: "attach" } %>
      </footer>
    </div>
  <% end %>
</turbo-frame>
