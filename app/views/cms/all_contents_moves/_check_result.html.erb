<%= form_tag({ action: :execute }, { method: :post }) do %>
  <div class="addon-views">
    <%= render "ss/crud/addon", addon: { id: "cms-all-contents-moves-check-result", head: t("cms.all_contents_moves.check_result_head") } do %>
      <table class="index">
        <thead>
          <tr>
            <th class="checkbox"><input type="checkbox" id="select-all" /></th>
            <th><%= t("all_content.page_id") %></th>
            <th><%= t("mongoid.attributes.cms/model/page.name") %></th>
            <th><%= t("mongoid.attributes.cms/model/page.filename") %></th>
            <th><%= t("cms.all_contents_moves.destination_filename") %></th>
            <th><%= t("mongoid.attributes.ss/document.state") %></th>
            <th><%= t("errors.template.header", count: 1) %></th>
            <th><%= t("cms.all_contents_moves.confirmations") %></th>
          </tr>
        </thead>
        <tbody>
          <% @check_result["rows"].each_with_index do |row, index| %>
            <tr class="<%= row["status"] %>">
              <td class="checkbox">
                <% if row["status"] == "ok" || row["status"] == "confirmation" %>
                  <%= check_box_tag "selected_ids[]", row["id"], false, id: "selected_ids_#{index}" %>
                <% end %>
              </td>
              <td><%= row["id"] %></td>
              <td>
                <% 
                  page = Cms::Page.site(@cur_site).where(id: row["id"]).first
                  if page
                    page_link = url_for(action: :show, controller: 'cms/pages', id: page.id)
                    link_to row["title"], page_link, target: "_blank", rel: "noopener"
                  else
                    row["title"]
                  end
                %>
              </td>
              <td><%= row["filename"] %></td>
              <td><%= row["destination_filename"] %></td>
              <td>
                <% case row["status"] %>
                <% when "ok" %>
                  <span class="status ok">OK</span>
                <% when "confirmation" %>
                  <span class="status confirmation"><%= t("cms.all_contents_moves.status_confirmation") %></span>
                <% when "error" %>
                  <span class="status error"><%= t("cms.all_contents_moves.status_error") %></span>
                <% end %>
              </td>
              <td>
                <% if row["errors"].present? %>
                  <ul class="errors">
                    <% row["errors"].each do |error| %>
                      <li><%= error %></li>
                    <% end %>
                  </ul>
                <% end %>
              </td>
              <td>
                <% 
                  status = row["status"] || row[:status]
                  if status == "confirmation" || status == :confirmation
                    confirmations = row["confirmations"] || row[:confirmations] || []
                    confirmations = [] if confirmations.nil?
                %>
                  <div class="confirmation-reason">
                    <p class="reason-text"><%= t("cms.all_contents_moves.confirmation_reason") %></p>
                    <% if confirmations.present? %>
                      <ul class="confirmations">
                        <% confirmations.each do |confirmation| %>
                          <li>
                            <% 
                              confirmation_hash = confirmation.is_a?(Hash) ? confirmation.with_indifferent_access : confirmation
                              type = confirmation_hash['type'] || confirmation_hash[:type]
                              confirmation_id = confirmation_hash['id'] || confirmation_hash[:id]
                              
                              item = nil
                              link_path = nil
                              item_name = nil
                              
                              case type.to_s
                              when 'page'
                                item = Cms::Page.site(@cur_site).where(id: confirmation_id).first
                                if item
                                  link_path = item.respond_to?(:private_show_path) ? item.private_show_path : url_for(action: :show, controller: 'cms/pages', id: item.id)
                                  item_name = item.name
                                end
                              when 'node'
                                item = Cms::Node.site(@cur_site).where(id: confirmation_id).first
                                if item
                                  link_path = item.respond_to?(:private_show_path) ? item.private_show_path : url_for(action: :show, controller: 'cms/nodes', id: item.id)
                                  item_name = item.name
                                end
                              when 'layout'
                                item = Cms::Layout.site(@cur_site).where(id: confirmation_id).first
                                if item
                                  link_path = url_for(action: :show, controller: 'cms/layouts', id: item.id)
                                  item_name = item.name
                                end
                              when 'part'
                                item = Cms::Part.site(@cur_site).where(id: confirmation_id).first
                                if item
                                  link_path = url_for(action: :show, controller: 'cms/parts', id: item.id)
                                  item_name = item.name
                                end
                              end
                              
                              type_label = type ? t("cms.all_contents_moves.confirmation_type_#{type}") : ""
                            %>
                            <% if item && link_path %>
                              <%= "#{type_label}: " %><%= link_to item_name, link_path, target: "_blank", rel: "noopener" %>
                            <% elsif type_label.present? %>
                              <%= "#{type_label}: #{confirmation_id}" %>
                            <% end %>
                          </li>
                        <% end %>
                      </ul>
                    <% end %>
                  </div>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>

  <footer class="send ss-sticky ss-sticky-bottom">
    <%= submit_tag t("ss.buttons.move"), name: 'execute', class: :save, data: { confirm: t("ss.confirm.move"), disable_with: t("ss.buttons.moving") } %>
    <%= link_to t("ss.buttons.back"), { action: :index }, class: "btn-back" %>
    <%= link_to t("ss.buttons.reset"), cms_all_contents_moves_reset_path, method: :post, class: "btn-default", data: { confirm: t("cms.all_contents_moves.confirm_reset") } %>
  </footer>
<% end %>

<%= jquery do %>
$("#select-all").on("change", function() {
  var checked = $(this).prop("checked");
  $("input[name='selected_ids[]']").prop("checked", checked);
});
<% end %>
