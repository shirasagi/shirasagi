<%= form_tag({ action: :execute }, { method: :post }) do %>
  <div class="addon-views">
    <%= render "ss/crud/addon", addon: { id: "cms-all-contents-moves-check-result", head: t("cms.all_contents_moves.check_result_head") } do %>
      <table class="index">
        <thead>
          <tr>
            <th class="checkbox"><input type="checkbox" id="select-all" /></th>
            <th><%= t("all_content.page_id") %></th>
            <th><%= t("mongoid.attributes.cms/model/page.name") %></th>
            <th><%= t("mongoid.attributes.cms/model/page.filename") %></th>
            <th><%= t("cms.all_contents_moves.destination_filename") %></th>
            <th><%= t("mongoid.attributes.ss/document.state") %></th>
            <th><%= t("errors.template.header", count: 1) %></th>
            <th><%= t("cms.all_contents_moves.confirmations") %></th>
          </tr>
        </thead>
        <tbody>
          <% @check_result["rows"].each_with_index do |row, index| %>
            <tr class="<%= row["status"] %>">
              <td class="checkbox">
                <% if row["status"] == "ok" || row["status"] == "confirmation" %>
                  <%= check_box_tag "selected_ids[]", row["id"], false, id: "selected_ids_#{index}" %>
                <% end %>
              </td>
              <td><%= row["id"] %></td>
              <td>
                <% 
                  page = Cms::Page.site(@cur_site).where(id: row["id"]).first
                  if page
                    page_link = url_for(action: :show, controller: 'cms/pages', id: page.id)
                %>
                  <%= link_to row["title"], page_link, target: "_blank", rel: "noopener" %>
                <% else %>
                  <%= row["title"] %>
                <% end %>
              </td>
              <td><%= row["filename"] %></td>
              <td><%= row["destination_filename"] %></td>
              <td>
                <% case row["status"] %>
                <% when "ok" %>
                  <span class="status ok">OK</span>
                <% when "confirmation" %>
                  <span class="status confirmation"><%= t("cms.all_contents_moves.status_confirmation") %></span>
                <% when "error" %>
                  <span class="status error"><%= t("cms.all_contents_moves.status_error") %></span>
                <% end %>
              </td>
              <td>
                <% if row["errors"].present? %>
                  <ul class="errors">
                    <% row["errors"].each do |error| %>
                      <li><%= error %></li>
                    <% end %>
                  </ul>
                <% end %>
              </td>
              <td>
                <% if row["status"] == "confirmation" && row["confirmations"].present? %>
                  <div class="confirmation-reason">
                    <p class="reason-text"><%= t("cms.all_contents_moves.confirmation_reason") %></p>
                    <ul class="confirmations">
                      <% row["confirmations"].each do |confirmation| %>
                        <li>
                          <% 
                            type = confirmation["type"]
                            confirmation_id = confirmation["id"]
                            
                            item = nil
                            link_path = nil
                            
                            case type
                            when 'page'
                              item = Cms::Page.site(@cur_site).where(id: confirmation_id).first
                              link_path = item&.private_show_path || url_for(action: :show, controller: 'cms/pages', id: confirmation_id) if item
                            when 'node'
                              item = Cms::Node.site(@cur_site).where(id: confirmation_id).first
                              link_path = item&.private_show_path || url_for(action: :show, controller: 'cms/nodes', id: confirmation_id) if item
                            when 'layout'
                              item = Cms::Layout.site(@cur_site).where(id: confirmation_id).first
                              link_path = url_for(action: :show, controller: 'cms/layouts', id: confirmation_id) if item
                            when 'part'
                              item = Cms::Part.site(@cur_site).where(id: confirmation_id).first
                              link_path = url_for(action: :show, controller: 'cms/parts', id: confirmation_id) if item
                            end
                            
                            type_label = t("cms.all_contents_moves.confirmation_type_#{type}")
                          %>
                          <% if item && link_path %>
                            <%= "#{type_label}: " %><%= link_to item.name, link_path, target: "_blank", rel: "noopener" %>
                          <% else %>
                            <%= "#{type_label}: #{confirmation_id}" %>
                          <% end %>
                        </li>
                      <% end %>
                    </ul>
                  </div>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>

  <footer class="send ss-sticky ss-sticky-bottom">
    <%= submit_tag t("ss.buttons.move"), name: 'execute', class: :save, data: { confirm: t("ss.confirm.move"), disable_with: t("ss.buttons.moving") } %>
    <%= link_to t("ss.buttons.reset"), cms_all_contents_moves_reset_path, method: :post, class: "btn-default", data: { confirm: t("cms.all_contents_moves.confirm_reset") } %>
  </footer>
<% end %>

<%= jquery do %>
$("#select-all").on("change", function() {
  var checked = $(this).prop("checked");
  $("input[name='selected_ids[]']").prop("checked", checked);
});
<% end %>
