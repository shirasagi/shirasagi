<%= jquery do %>
SS_Notice.renderNotice("<%= flash[:notice] %>", { type: "notice" });
<% end %>

<div class="cms-tabs">
  <%= link_to cms_all_contents_download_path do %>
    <span class="tab-name"><%= t("cms.all_content.download_tab") %></span>
  <% end %>
  <%= link_to cms_all_contents_import_path do %>
    <span class="tab-name"><%= t("cms.all_content.import_tab") %></span>
  <% end %>
  <%= link_to cms_all_contents_sampling_path do %>
    <span class="tab-name"><%= t("cms.all_content.sampling_tab") %></span>
  <% end %>
  <%= link_to cms_all_contents_moves_path, class: 'current' do %>
    <span class="tab-name"><%= t("cms.all_content.moves_tab") %></span>
  <% end %>
</div>

<% if @task.running? || @task.ready? %>
  <div class="job-status" data-task-id="<%= @task.id %>" data-task-type="check">
    <dl class="see">
      <% if @task.segment.present? %>
        <dt><%= @task.t :segment %></dt>
        <dd><%= "#{@task.segment}: #{t('cms.all_contents_moves.status.reading_csv')}" %></dd>
      <% end %>
      <dt><%= @task.t :state %></dt>
      <dd>
        <span class="state" data-state="<%= @task.state %>">
          <% if @task.state %>
            <%= t("job.state.#{@task.state}") %>
          <% end %>
        </span>
      </dd>
      <% if @task.total_count > 0 || @task.current_count > 0 %>
        <dt><%= @task.t :current_count %></dt>
        <dd class="count">
          <%= @task.current_count %>
          <% if @task.total_count > 0 %>
            / <%= @task.total_count %>
          <% end %>
        </dd>
      <% end %>
      <dt><%= @task.t :started %></dt>
      <dd class="started"><%= @task.started.try { |time| ss_time_tag(time) } %></dd>
      <dt><%= t("ss.links.job_log") %></dt>
      <dd><%= link_to t("ss.links.job_log"), job_cms_task_path(id: @task.id), target: "_blank" %></dd>
    </dl>
  </div>
<% elsif @execute_task && (@execute_task.running? || @execute_task.ready?) %>
  <div class="job-status" data-task-id="<%= @execute_task.id %>" data-task-type="execute">
    <dl class="see">
      <% csv_filename = @execute_task.segment.presence || @task.segment %>
      <% if csv_filename.present? %>
        <dt><%= @execute_task.t :segment %></dt>
        <dd><%= "#{csv_filename}: #{t('cms.all_contents_moves.status.executing')}" %></dd>
      <% end %>
      <dt><%= @execute_task.t :state %></dt>
      <dd>
        <span class="state" data-state="<%= @execute_task.state %>">
          <% if @execute_task.state %>
            <%= t("job.state.#{@execute_task.state}") %>
          <% end %>
        </span>
      </dd>
      <% if @execute_task.total_count > 0 || @execute_task.current_count > 0 %>
        <dt><%= @execute_task.t :current_count %></dt>
        <dd class="count">
          <%= @execute_task.current_count %>
          <% if @execute_task.total_count > 0 %>
            / <%= @execute_task.total_count %>
          <% end %>
        </dd>
      <% end %>
      <dt><%= @execute_task.t :started %></dt>
      <dd class="started"><%= @execute_task.started.try { |time| ss_time_tag(time) } %></dd>
      <dt><%= t("ss.links.job_log") %></dt>
      <dd><%= link_to t("ss.links.job_log"), job_cms_task_path(id: @execute_task.id), target: "_blank" %></dd>
    </dl>
  </div>
<% elsif @check_result %>
  <% if @execute_result %>
    <%= render "execute_result" %>
  <% else %>
    <%= render "check_result" %>
  <% end %>
<% else %>
  <%= render "upload_form" %>
<% end %>

<%= jquery do %>
  (function() {
    var $jobStatus = $(".job-status");
    if ($jobStatus.length === 0) {
      return;
    }

    var taskId = $jobStatus.data("task-id");
    var taskType = $jobStatus.data("task-type");
    var checkUrl = "<%= job_cms_task_path(id: '__TASK_ID__', format: :json) %>".replace("__TASK_ID__", taskId);
    var currentState = $jobStatus.find(".state").data("state");
    var interval = <%= SS.config.job.reload_interval || 10 %> * 1000; // ミリ秒に変換
    var timerId;

    var checkJobStatus = function() {
      $.ajax({
        url: checkUrl,
        cache: false,
        dataType: "json",
        success: function(data) {
          var newState = data.state;
          
          // 状態を更新
          if (newState !== currentState) {
            currentState = newState;
            $jobStatus.find(".state")
              .text(data.state_label || "")
              .data("state", newState);
            
            // 進捗を更新
            if (data.current_count !== undefined) {
              var countText = data.current_count.toString();
              if (data.total_count && data.total_count > 0) {
                countText += " / " + data.total_count.toString();
              }
              $jobStatus.find(".count").text(countText);
            }
            
            // 開始時刻を更新
            if (data.started) {
              var $started = $jobStatus.find(".started");
              if ($started.find("time").length > 0) {
                $started.find("time").text(SS.formatTime(data.started, "picker"));
              } else {
                $started.html('<time>' + SS.formatTime(data.started, "picker") + '</time>');
              }
            }
          }
          
          // ジョブが完了したら画面をリロード
          if (newState === "completed" || newState === "failed" || newState === "interrupted") {
            clearInterval(timerId);
            // 少し待ってからリロード（結果が保存される時間を確保）
            setTimeout(function() {
              location.reload();
            }, 1000);
          }
        },
        error: function() {
          // エラーが発生しても継続してポーリング
        }
      });
    };

    // 定期的にジョブの状態をチェック
    timerId = setInterval(checkJobStatus, interval);
    // 初回は即座にチェック
    checkJobStatus();
  })();
<% end %>
