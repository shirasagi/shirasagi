<%
  action = params[:action]
  is_changeable = permitted && (item.try(:state_changeable?) || action == "destroy_all")
  errors = @item_errors.present? ? (@item_errors[item.id] || SS::EMPTY_HASH) : SS::EMPTY_HASH
  hide_checkbox =
    (!ignore_alert_to_contains_urls? && errors[:contains_urls_error].present?) && action == "close_all" ||
      (!ignore_alert_to_syntax_check? && errors[:syntax_context].present? && action == "publish_all")
  show_unchecked_checkbox =
    (ignore_alert_to_contains_urls? && errors[:contains_urls_error].present?) && action == "close_all" ||
      (ignore_alert_to_syntax_check? && errors[:syntax_context].present? && action == "publish_all")
%>
<li class="list-item" data-id="<%= item.id %>">
  <%
    if permitted
      if show_unchecked_checkbox
        chk = check_box_tag "ids[]", item.id, false, id: nil
      elsif hide_checkbox || !is_changeable
        # don't show checkbox
        chk = check_box_tag "ids[]", item.id, false, id: nil, disabled: true, style: "visibility: hidden;"
      else
        chk = check_box_tag "ids[]", item.id, true, id: nil
      end
    else
      chk = check_box_tag "ids[]", item.id, false, id: nil, disabled: true
    end
  %>
  <% if chk %>
    <label class="check"><%= chk %></label>
  <% end %>
  <div class="info">
    <%=
      show_path = url_for(action: :show, id: item) rescue nil
      if show_path
        link_to item.try(:name), show_path, class: "title", target: "_blank", rel: "noopener"
      end
    %>
    <div class="meta">
      <%= render "cms/crud/destroy_info", item: item, action: action %>
      <% if item.try(:tags) %>
        <span class="tags"><%= item.tags.join(",") %></span>
      <% end %>
    </div>
  </div>
  <% if errors.present? || (!permitted && message) %>
    <div class="list-item-error">
      <h2 class="list-item-error-header"><%= t("cms.alert") %></h2>
      <%= render SS::MoreContentComponent.new(cur_site: @cur_site, cur_user: @cur_user) do %>
        <% if !permitted && message %>
          <section class="list-item-error-section" data-error="system">
            <header class="list-item-error-section-header"><%= t("errors.template.body") %></header>
            <ul class="list-item-error-section-body">
              <li><%= message %></li>
            </ul>
          </section>
        <% end %>

        <% errors.each do |key, value| %>
          <% case key %>
        <% when :contains_urls_error %>
            <section class="list-item-error-section" data-error="<%= key %>">
              <header class="list-item-error-section-header"><%= t("cms.backlink_check") %></header>
              <ul class="list-item-error-section-body">
                <li><%= link_to(value, url_for(action: :contains_urls, id: item), class: "contains-urls", target: :_blank, rel: "noopener") rescue value %></li>
              </ul>
            </section>
          <% when :branch_page_error %>
            <section class="list-item-error-section" data-error="<%= key %>">
              <header class="list-item-error-section-header"><%= t("workflow.branch_page") %></header>
              <ul class="list-item-error-section-body">
                <li><%= value %></li>
              </ul>
            </section>
          <% when :syntax_context %>
            <section class="list-item-error-section" data-error="<%= key %>">
              <header class="list-item-error-section-header"><%= t("cms.syntax_check") %></header>
              <ul class="list-item-error-section-body">
                <% value.errors.each do |error| %>
                  <% next if error.id.blank? %>
                  <li><%= error.full_message %></li>
                <% end %>
              </ul>
            </section>
          <% else %>
            <% Rails.logger.warn { "unknown error type: #{key}"  } %>
            <section class="list-item-error-section" data-error="<%= key %>">
              <ul class="list-item-error-section-body">
                <li><%= value %></li>
              </ul>
            </section>
          <% end %>
        <% end %>
      <% end %>
    </div>
  <% end %>
</li>
