<%= coffee do %>
$ ->
  point_link = $(".point .add")

  $.ajax
    url: "<%= @cur_page.point_url %>"
    success: (data)->
      $(".point .count .number").text data["point"]
      if data["mode"] == "entry"
        # add
      else if data["mode"] == "cancel"
        point_link.removeClass("add").addClass("cancel")
      else
        point_link.remove()

  point_link.click (event)->
    $.ajax
      url: "<%= @cur_page.point_add_url %>"
      success: (data)->
        $(".point .count .number").text data["point"]
        if data["mode"] == "cancel"
          point_link.removeClass("add").addClass("cancel")
        else
          point_link.removeClass("cancel").addClass("add")
    event.preventDefault()

  $(".categories a[data-class=other]").click ->
    type = $(this).attr("class")
    $(".categories a." + type).show()
    $(this).remove()
    return false
<% end %>

<header>
  <h1 class="name"><%= @cur_page.send :name %></h1>
</header>

<div class="point">
  <div class="count">
    <span class="number"><%= @cur_page.point %></span>
    <span class="label">いいね！数</span>
  </div>
  <%= link_to "いいね！", "#", class: "add" %>
</div>

<%
max = 3
categories = [
  { items: @cur_page.categories, type: :category, name: :name, id: :id },
  { items: @cur_page.areas.sort(order: 1), type: :area, name: :name, id: :id },
  { items: @cur_page.tags, type: :tag, name: :to_s, id: :to_s },
]
%>
<nav class="categories">
  <% categories.each do |cate| %>
    <% cate[:items].each_with_index do |item, idx| %>
      <% hide = (idx >= max) ? "display: none" : nil %>
      <%= link_to item.send(cate[:name]), "#{@search_url}?s[#{cate[:type]}_id]=#{item.send(cate[:id])}",
        class: cate[:type], style: hide %>
    <% end %>
    <% if cate[:items].size > max %>
      <%= link_to "他#{cate[:items].size-max}件", "#",
        class: "#{cate[:type]}", "data-class" => "other" %>
    <% end %>
  <% end %>
</nav>

<div class="text">
  <%= auto_link br(@cur_page.text), html: { target: "_blank" } %>
</div>

<div class="detail">
  <nav>
    <%= link_to "データ作品の情報", "#", class: "info" %>
    <%= link_to "データの内容", "#", class: "data" %>
    <%= link_to "アプリ", "#", class: "app" %>
    <%= link_to "アイデア", "#", class: "idea" %>
  </nav>

  <section class="info">
    <header>
      <h1>ダウンロード</h1>
    </header>

    <div class="resources">
      <% @cur_page.resources.each do |rs| %>
      <div class="resource">
        <div class="name format-<%= rs.format.downcase %>">
          <%= rs.name %> (<%= rs.format %> <%= number_to_human_size(rs.size) %>)
        </div>
        <div class="icons">
          <% if license = rs.license %>
          <span class="license"><%= tryb { image_tag license.file.url, alt: license.name } || license.name %></span>
          <% end %>
          <%= link_to "ダウンロード", rs.url, class: "download" %>
        </div>
        <% if rs.text.present? %>
        <div class="text">
          <%= auto_link br(rs.text), html: { target: "_blank" } %>
        </div>
        <% end %>
        <% if rs.rdf_iri.present? %>
        <div class="sparql">
          <%= rs.t :rdf_iri %> <%= link_to rs.rdf_iri, "#{sparql_path}?graph_name=#{rs.rdf_iri}" %>
        </div>
        <% end %>
      </div>
      <% end %>
    </div>

    <dl class="author">
      <% if @cur_page.member_id.present? %>
        <dt><%= @cur_page.t :member_id %></dt>
        <dd><%= tryb{@cur_page.member.name} %></dd>
      <% else %>
        <dt><%= @cur_page.t :user_id %></dt>
        <dd><%= tryb{@cur_page.user.name} %></dd>
      <% end %>

      <% if @cur_page.related_url.present? %>
        <dt><%= @cur_page.t :related_url %></dt>
        <dd><%= link_to @cur_page.related_url, @cur_page.related_url, target: "_blank" %></dd>
      <% end %>

      <dt><%= @cur_page.t :downloaded %></dt>
      <dd><%= @cur_page.downloaded.to_i %> 回</dd>

      <dt><%= @cur_page.t :updated %></dt>
      <dd><%= tryb{@cur_page.updated.strftime("%Y年%m月%1d日")} %></dd>
    </dl>
  </section>
</div>

<%= render file: "contact/agents/addons/page/view/index" %>
