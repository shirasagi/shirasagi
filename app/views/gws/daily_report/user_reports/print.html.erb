<%= render 'ss/crud/print_preview_head', links: [[ I18n.t('ss.links.back'), { action: :index } ]] %>

<div class="addon-views sheet gws-daily-report-print">
  <div class="addon-view print" id="addon-basic">
    <div class="addon-body print">
      <table class="index">
        <thead>
        <tr>
          <th><%= t('gws/daily_report.date') %></th>
          <th><%= t('gws/daily_report.wday') %></th>
          <% if @forms.present? %>
            <% if @model.allowed?(:access, @cur_user, site: @cur_site) || @user.id == @cur_user.id %>
              <th class="limited-access"><%= @model.t(:limited_access) %></th>
            <% end %>
            <th><%= @model.t(:small_talk) %></th>
            <% @forms.first.columns.each do |column| %>
              <th><%= column.name %></th>
            <% end %>
          <% end %>
        </tr>
        </thead>
        <tbody>
        <% (@cur_month.beginning_of_month.to_date..@cur_month.end_of_month.to_date).each do |date| %>
          <% report = @items.where(form_id: @forms.first.try(:id), daily_report_date: date).first %>
          <tr>
            <td><%= I18n.l(date, format: :short) %></td>
            <td><%= t("date.abbr_day_names")[date.wday] %></td>
            <% if report %>
              <% if @model.allowed?(:access, @cur_user, site: @cur_site) || @user.id == @cur_user.id %>
                <td>
                  <div class="report-value-wrap">
                    <div class="report-value"><%= br report.limited_access %></div>
                  </div>
                </td>
              <% end %>
              <% if report.share_small_talk.present? %>
                <td class="share-cell">
                  <div class="share-value"><%= t('gws/daily_report.shared') %></div>
                  <div class="report-value-wrap">
                    <div class="report-value"><%= br report.small_talk %></div>
                  </div>
                  <% report.column_comments('small_talk').each do |comment| %>
                    <div class="comment-value"><%= br comment.body %>(<%= comment.user.try(:name) %>)</div>
                  <% end %>
                </td>
              <% else %>
                <td>
                  <% if report.manageable?(@cur_user, site: @cur_site, date: date) && report.small_talk.present? %>
                    <div class="report-value-wrap">
                      <div class="report-value"><%= br report.small_talk %></div>
                    </div>
                    <% report.column_comments('small_talk').each do |comment| %>
                      <div class="comment-value"><%= br comment.body %>(<%= comment.user.try(:name) %>)</div>
                    <% end %>
                  <% end %>
                </td>
              <% end %>
              <% report.column_values.each do |column_value| %>
                <% if report.share_column_ids.include?(column_value.column.id.to_s) %>
                  <td class="share-cell">
                    <div class="share-value"><%= t('gws/daily_report.shared') %></div>
                    <div class="report-value-wrap">
                      <div class="report-value"><%= br column_value.value %></div>
                    </div>
                    <% report.column_comments(column_value.column_id).each do |comment| %>
                      <div class="comment-value"><%= br comment.body %>(<%= comment.user.try(:name) %>)</div>
                    <% end %>
                  </td>
                <% else %>
                  <td>
                    <% if report.manageable?(@cur_user, site: @cur_site, date: date) && column_value.value.present? %>
                      <div class="report-value-wrap">
                        <div class="report-value"><%= br column_value.value %></div>
                      </div>
                      <% report.column_comments(column_value.column_id).each do |comment| %>
                        <div class="comment-value"><%= br comment.body %>(<%= comment.user.try(:name) %>)</div>
                      <% end %>
                    <% end %>
                  </td>
                <% end %>
              <% end %>
            <% elsif @forms.present? %>
              <% if @model.allowed?(:access, @cur_user, site: @cur_site) || @user.id == @cur_user.id %>
                <td></td>
              <% end %>
              <td></td>
              <% @forms.first.columns.each do |column| %>
                <td></td>
              <% end %>
            <% end %>
          </tr>
        <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
