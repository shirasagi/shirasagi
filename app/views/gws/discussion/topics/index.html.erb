<%= jquery do %>
Gws_Discussion_Thread.render(<%= @cur_user.id %>);
<% if @cur_site.discussion_unseen_interval.present? %>
Gws_Discussion_Unseen.renderUnseen(
  "<%= gws_discussion_apis_unseen_path(id: @forum.id) %>",
  <%= @cur_site.discussion_unseen_interval %>,
  <%= @forum.descendants_updated.to_i %>
);
<% end %>
<% end %>

<h2 class="gws-discussion-topic"><%= @forum.name %></h2>

<p class="gws-discussion-unseen" style="display: none;">
  <%= link_to t("gws/discussion.notice.reload"), { action: :index } %>
</p>

<%= paginate @items if @items.try(:current_page) %>

<div class="row">
  <div class="gws-discussion gws-discussion-thread col-sm-9">
    <% @items.each do |item| %>
      <%= form_for :item, url: { action: :reply, id: item.id }, html: { method: :put, multipart: true, autocomplete: :off } do |f| %>
        <%= render partial: 'thread', locals: { f: f, topic: item, limit: 5, reply_menu: true } %>
      <% end %>
    <% end %>
    <% if @items.blank? %>
      <div class="card mb-3">
        <div class="card-body">
          <dl class="see">
            <dd class="wide">
              <%= t("gws/discussion.notice.no_topics") %>
            </dd>
          </dl>
        </div>
      </div>
    <% end %>
    <%= paginate @items if @items.try(:current_page) %>
  </div>

  <div class="gws-discussion-navi col-sm-3">
    <% if Gws::Schedule::Todo.allowed?(:read, @cur_user, site: @cur_site) %>
    <div class="card mb-3">
      <div class="card-header"><h2><%= t("gws/discussion.todos") %></h2></div>
      <% @todos.each do |todo| %>
      <div class="card-body border-bottom">
        <%= link_to todo.name, gws_discussion_forum_todo_path(id: todo.id) %><br />
        <%= term(todo) %>
      </div>
      <% end %>
      <% if @todos.blank? %>
      <div class="card-body border-bottom">
        <%= t("gws/discussion.notice.no_todos") %>
      </div>
      <% end %>
      <div class="card-footer border-0">
        <%= link_to t("gws/discussion.links.todo.index"), gws_discussion_forum_todos_path, class: "btn btn-primary" %>
      </div>
    </div>
    <% end %>

    <div class="card mb-3">
      <div class="card-header"><h2><%= t("gws/discussion.topics") %></h2></div>
      <% @recent_items.each do |item| %>
        <div class="card-body border-bottom">
          <% if item.new_flag? %><span class="gws-board-flag-new"></span><% end %>
          <%= link_to item.name, gws_discussion_forum_topic_comments_path(forum_id: @forum.id, topic_id: item.id) %><br />
          <p class="text-secondary"><%= item.descendants_updated.strftime("%Y/%m/%d %H:%M") rescue nil %></p>
        </div>
      <% end %>
      <% if @recent_items.blank? %>
        <div class="card-body">
          <%= t("gws/discussion.notice.no_recents") %>
        </div>
      <% end %>
      <div class="card-footer border-0">
        <%= link_to t("gws/discussion.links.topic.index"), { action: :all }, { class: "btn btn-primary"} %>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header"><h2><%= t("gws/discussion.members") %></h2></div>
      <div class="card-body">
        <% @forum.discussion_members.each do |member| %>
          <p><%= member.long_name %></p>
        <% end %>
      </div>
    </div>

    <% if quota = @forum.forum_quota_model %>
    <div class="card mb-3">
      <div class="card-header"><h2><%= t('ss.quota') %></h2></div>
      <div class="card-body">
        <div class="ss-quota-bar">
          <% quota = @forum.forum_quota_model %>
          <div class="label"><%= quota.label %></div>
          <div class="usage <%= quota.over? ? 'over-threshold' : '' %>" style="width: <%= quota.percentage %>%"></div>
        </div>
      </div>
    </div>
    <% end %>
  </div>
</div>
