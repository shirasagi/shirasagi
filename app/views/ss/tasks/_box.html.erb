<%
  limit ||= SS.config.job.head_logs || 1_000
  reload_interval ||= SS.config.job.reload_interval || 10_000
  show_current_count = local_assigns.fetch(:show_current_count, false)

  url ||= url_for(format: :json)
%>

<section class="main-box task-box" id="task-box-<%= task.id %>">
  <dl class="info">
    <dt><%= task.t :state %></dt>
    <dd class="state" data-state="<%= task.state %>">
      <% if task.state %>
        <%= t("job.state.#{task.state}") %>
      <% end %>
    </dd>

    <% if show_current_count %>
      <dt><%= task.t :current_count %></dt>
      <dd class="count">
        <%= task.current_count %>
        <% if task.total_count > 0 %>
          / <%= task.total_count %>
        <% end %>
      </dd>
    <% end %>

    <dt><%= task.t :started %></dt>
    <dd class="started"><%= task.started.try { |time| content_tag(:time, I18n.l(time, format: :picker), datetime: time.utc.iso8601) } %></dd>

    <dt><%= task.t :closed %></dt>
    <dd class="closed"><%= task.closed.try { |time| content_tag(:time, I18n.l(time, format: :picker), datetime: time.utc.iso8601) } %></dd>
  </dl>

  <div class="logs">
    <%= t('job.log_notice', count: limit) %>
    <textarea class="log" readonly="readonly"><%= task.head_logs(limit).join("\n") %></textarea>
    <% if task.respond_to?(:log_file_path) %>
      <%
        if @ss_mode == :cms && @cur_site
          download_path = download_job_cms_task_path(id: task)
        else
          download_path = download_job_sys_task_path(id: task)
        end
      %>
      <%= link_to(t('job.download_log'), download_path, { class: "btn task-log-download-btn hide", target: "_blank" }) %>
    <% end %>
  </div>
</section>

<%= jquery do %>
  var $el = $("#task-box-<%= task.id %>");

  var formatCount = function(current, total) {
    if (total && total > 0) {
      return current.toString() + "/" + total.toString();
    } else {
      return current.toString();
    }
  };

  var formatTime = function(time) {
    if (! time) {
      return "";
    }

    time = moment(time);
    return $("<time />", { datetime: time.toISOString() }).html(SS.formatTime(time));
  };

  var reload = function () {
    var state = $el.find(".state").data("state");
    if (!state.match(/(ready|running)/)) {
      return;
    }

    $.ajax({
      url: "<%= url %>",
      data: { head_logs: <%= limit %> },
      success: function (data) {
        $el.find(".state").html(data["state_label"] || "").data("state", data["state"]);
        $el.find(".count").html(formatCount(data["current_count"], data["total_count"]));
        $el.find(".started").html(formatTime(data["started"]));
        $el.find(".closed").html(formatTime(data["closed"]));
        $el.find(".log").val(data["head_logs"].join("\n"));
        if (data["state"] === "stop") {
          $el.find(".stop-button").hide();
          $el.find(".run-button").show();
        }

        if ($el.find(".log").val()) {
          $el.find(".task-log-download-btn").removeClass("hide");
        } else {
          $el.find(".task-log-download-btn").addClass("hide");
        }
      }
    });
  };

  setInterval(reload, <%= reload_interval %>);

  if ($el.find(".log").val()) {
    $el.find(".task-log-download-btn").removeClass("hide");
  }
<% end %>
