<% return if !Gws::Memo::Message.allowed?(:edit, @cur_user, site: @cur_site) %>

<%
   search_condition = SS.config.gws.dig("popup_notice", "search_condition")
  if search_condition == "unseen"
    default_label  = t("gws/memo/message.links.seens")
    switched_label = t("gws/memo/message.links.unseens")
    default_url    = recent_gws_memo_messages_path(s: { unseen: @cur_user.id })
    switched_url   = recent_gws_memo_messages_path
  else
    default_label  = t("gws/memo/message.links.unseens")
    switched_label = t("gws/memo/message.links.seens")
    default_url    = recent_gws_memo_messages_path
    switched_url   = recent_gws_memo_messages_path(s: { unseen: @cur_user.id })
  end
%>
<%= jquery do %>
  $(".gws-memo-message .unseens").click(function() {
    $(".gws-memo-message.popup-notice-container [data-url]").each(function() {
      var url = $(this).attr("data-url");
      var switched = $(this).attr("data-url-switched");
      $(this).attr("data-url", switched);
      $(this).attr("data-url-switched", url);
    });
    var label = $(this).text();
    var switched = $(this).attr("data-label-switched");
    $(this).text(switched);
    $(this).attr("data-label-switched", label);
  });
  (new SS_PopupNotice(".gws-memo-message.popup-notice-container")).render();
<% end %>
<div class="gws-memo-message popup-notice-container dropdown">
  <%= link_to gws_memo_messages_path, "class" => "user-message ajax-popup-notice toggle-popup-notice dropdown-toggle", "data-url" => default_url, "data-url-switched" => switched_url, "id" => "dropdown-message", "data-toggle" => "dropdown", "aria-haspopup" => "true", "aria-expanded" => "false" do %>
    <% count = Gws::Memo::Message.unseens(@cur_user, @cur_site).size %>
    <% if count > 0 %><span class="unseen"><%= count %></span><% end %>
  <% end %>
  <div class="popup-notice dropdown-menu" aria-labelledby="dropdown-message">
    <header class="popup-notice-header d-flex justify-content-between align-items-center p-2">
      <h2>
        <%= t('modules.gws/memo/message') %>
      </h2>
      <p>
        <%= link_to default_label, "#",
          "class" => "ajax-popup-notice unseens",
          "data-url" => default_url,
          "data-url-switched" =>  switched_url,
          "data-label-switched" => switched_label
        %>
      </p>
    </header>
    <div class="dropdown-divider"></div>
    <div class="popup-notice-items"></div>
    <div class="dropdown-divider"></div>
    <div class="text-center"><%= link_to t("ss.links.more_all"), gws_memo_messages_path, class: "btn btn-secondary" %></div>
  </div>
</div>
