<%= jquery do %>

var onSelect;
var $element = $.colorbox.element();
if ($element) {
  onSelect = $element.data('on-select');
}

SS.ajaxForm("form.user-file", {
  success: function(data) {
    $("#cboxLoadedContent").load("<%= url_for(action: :index) %>", function() {
      if (!Array.isArray(data) || data.length == 0) return;

      $.each(data, function(index, file) {
        var item = $(".user-files .select[data-id='" + file._id + "']");
        var url = item.attr('href');
        if (!url) return true;
        if (onSelect) {
          onSelect(item);
        } else {
          $.ajax({
            url: url,
            success: function(data) {
              $("#selected-files").append(data);
            }
          });
        }
      });
      $.colorbox.close();
    });
  },
  error: function(xhr) {
    if (xhr.status == 413) {
      alert(["== Error =="].concat("<%= I18n.t('errors.messages.request_entity_too_large') %>").join("\n"));
    } else {
      alert(["== Error =="].concat(xhr.statusText).join("\n"));
    }
  }
});

if (onSelect) {
  $(".user-files .select").on('click', function(e) {
    onSelect($(this));
    e.preventDefault();
    return false;
  });
} else {
  SS.ajax(".user-files .select", {
    success: function(data) {
      $("#selected-files").append(data);
      $.colorbox.close();
    }
  });
}

SS.ajaxDelete(".user-files .delete");

var resizing = $('#file-resizing').val();
if (resizing) {
  var label = $('#file-resizing').attr('data-label');
  var option = $('<option>').val(resizing).text(label).prop('selected', true);
  $('select.image-size').append(option);
}
<% end %>

<% if @model.allowed?(:edit, @cur_user, site: @cur_site, node: @cur_node) %>
  <%= form_for :item, url: { action: :create }, html: { class: "user-file", multipart: true } do |f| %>
  <%= error_messages_for :item %>

    <div class="search-ui-form mb-3">
      <div class="row align-items-center mb-3">
        <div class="col">
          <%= f.file_field :in_files, multiple: :multiple, required: :required, class: "form-control-file" %>
        </div>
        <div class="col">
          <%= f.select :resizing, @model.resizing_options, { include_blank: t("ss.resize_image") }, { class: "image-size" } %>
        </div>
      </div>
      <div class="d-flex justify-content-center"><%= f.submit t("ss.buttons.save"), class: "save btn btn-outline-primary" %></div>
    </div>

  <% end %>
<% end %>

<div class="user-files card-columns">
  <% @items.each do |item| %>
  <article class="file-view card" id="user-file<%= item.id %>">
    <a class="thumb select card-img-top" href="<%= url_for action: :select, id: item %>" data-id="<%= item.id %>" data-humanized-name="<%= item.humanized_name %>">
      <% if item.image? %>
      <img src="<%= url_for(action: :thumb, id: item, _: item.updated.to_i) %>" alt="<%= item.basename %>" />
      <% else %>
      <span class="ext icon-<%= item.extname %>"><%= item.extname %></span>
      <% end %>
    </a>
    <div class="card-body">
      <p class="name"><%= item.name %></p>
      <% if item.allowed?(:edit, @cur_user, site: @cur_site) %>
        <%= link_to t("ss.buttons.edit"), { action: :edit, id: item }, class: "edit btn btn-secondary" %>
      <% end %>
      <% if item.allowed?(:delete, @cur_user, site: @cur_site) %>
        <%= link_to t("ss.buttons.delete"), { action: :destroy, id: item }, class: "delete btn btn-secondary", "data-remove" => "#user-file#{item.id}" %>
      <% end %>
    </div>
  </article>
  <% end %>
</div>

<div style="clear: both;"></div>

<%= paginate @items if @items.try(:current_page) %>
