language: ruby
dist: trusty
sudo: false
rvm:
  - 2.6.3

cache:
  apt: true
  bundler: true
  directories:
    - $HOME/.local

services:
  - mongodb

addons:
  chrome: stable
  apt:
    packages:
      - imagemagick
      - libmagick++-dev
      - sox
      - libsox-dev
      - lame
      - libmp3lame-dev
      - chromium-chromedriver
      # open-jtalk package is blacklisted
      # - open-jtalk
      # ubuntu 12.04 mecab is too old to work
      # - mecab
      # - libmecab-dev
      # - mecab-ipadic-utf8

bundler_args: "--without development"

before_install:
  - export PATH=$PATH:$HOME/.local/bin
  - export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$HOME/.local/lib
  - export LD_RUN_PATH=$LD_RUN_PATH:$HOME/.local/lib
  - export TZ=Asia/Tokyo

install:
  - bash .travis.d/install.sh

before_script:
  - export allow_open_jtalk=1
  - bash .travis.d/before_script.sh

#script:
#  - travis_wait 60 bash .travis.d/script.sh

jobs:
  include:
    - stage: test
      script: bundle exec rspec -p 10 spec/ --pattern "spec/features/{a,b,c,d,e,f}*/**/*.rb"
      name: "Features_A"
    - script: bundle exec rspec -p 10 spec/ --pattern "spec/features/{g}*/**/*.rb" --exclude "**/gws/schedule/**/*.rb"
      name: "Features_G"
    - script: bundle exec rspec -p 10 spec/ --pattern "spec/features/gws/schedule/**/*.rb"
      name: "Features_G (Schedule)"
    - script: bundle exec rspec -p 10 spec/ --pattern "spec/features/{h,i,j,k,l,m,o}*/**/*.rb"
      name: "Features_H"
    - script: bundle exec rspec -p 10 spec/ --pattern "spec/features/{p,q,r,s,u,v,w}*/**/*.rb"
      name: "Features_P"
    - script: bundle exec rspec -p 10 spec/models/
      name: "Models"
    - script: bundle exec rspec -p 10 spec/jobs/
      name: "Jobs"
    - script: bundle exec rspec -p 10 spec/ --pattern "spec/{helpers,lib,mailers,requests,validators}*/**/*.rb"
      name: "Other (Helpers,Lib,Mailers,Requests,Validators)"
